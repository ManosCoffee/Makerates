
id: debug_envs_advanced
namespace: makerates

tasks:
  - id: log_context
    type: io.kestra.core.tasks.log.Log
    message: |
      === DEBUGGING CONTEXT (ENV VARS) ===
      1. Envs Keys: {{ envs | keys }}
      2. DLT_BUCKET: {{ envs.destination__filesystem__bucket_url ?? 'NOT_FOUND' }}
      3. DLT_ACCESS_KEY: {{ envs.destination__filesystem__credentials__aws_access_key_id ?? 'NOT_FOUND' }}
      4. DDB_ACCESS_KEY: {{ envs.dynamodb_aws_access_key_id ?? 'NOT_FOUND' }}
      5. DLT_LAYOUT: {{ envs.destination__filesystem__layout ?? 'NOT_FOUND' }}
      ====================================

  - id: log_context_2
    type: io.kestra.core.tasks.log.Log
    message: |
      === DEBUGGING CONTEXT (ENV VARS) ===
      1. Envs Keys: {{ envs | keys }}
      2. DLT_BUCKET: {{ envs.destination__filesystem__bucket_url ?? 'NOT_FOUND' }}
      3. DLT_ACCESS_KEY: {{ envs.destination__filesystem__credentials__aws_access_key_id ?? 'NOT_FOUND' }}
      4. DDB_ACCESS_KEY: {{ envs.dynamodb_aws_access_key_id ?? 'NOT_FOUND' }}
      5. DLT_LAYOUT: {{ envs.destination__filesystem__layout ?? 'NOT_FOUND' }}
      ====================================

  - id: check_docker_env
    type: io.kestra.plugin.docker.Run
    containerImage: makerates-ingestion-base:latest
    pullPolicy: NEVER
    networkMode: makerates-network
    env:
      DESTINATION__FILESYSTEM__LAYOUT: "{{ envs.destination__filesystem__layout }}"
      DESTINATION__FILESYSTEM__KWARGS__CLIENT_KWARGS: "{{ envs.destination__filesystem__kwargs__client_kwargs }}"
    # commands:
    #   - echo "=== DOCKER ENV CHECK ==="
    #   - echo "LAYOUT: $DESTINATION__FILESYSTEM__LAYOUT"
    #   - echo "CLIENT_KWARGS: $DESTINATION__FILESYSTEM__KWARGS__CLIENT_KWARGS"
    #   - echo "=== FILE SYSTEM CHECK ==="
    #   - ls -la /app/.dlt || echo "No .dlt dir"
    #   - echo "========================"
    entryPoint:
      - /bin/sh
      - -c
      - >
        echo "LAYOUT: $DESTINATION__FILESYSTEM__LAYOUT" &&
        echo "CLIENT_KWARGS: $DESTINATION__FILESYSTEM__KWARGS__CLIENT_KWARGS" &&
        echo "=== FILE SYSTEM CHECK ===" &&
        ls -la /app/.dlt || echo "No .dlt dir" &&
        echo "========================"

